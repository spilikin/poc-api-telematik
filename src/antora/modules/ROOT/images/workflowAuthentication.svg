<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3133px" preserveAspectRatio="none" style="width:2219px;height:3133px;" version="1.1" viewBox="0 0 2219 3133" width="2219px" zoomAndPan="magnify"><defs><filter height="300%" id="fb0tlklu3ox4y" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><image height="64" width="64" x="1019.5" xlink:href="data:image/png;base64,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" y="12"/><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="0" x="1088.5" y="72.0449"/><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" text-decoration="underline" textLength="104" x="1088.5" y="72.0449">IDP workflow</text><rect fill="#87CEEB" height="3043.2344" rx="10" ry="10" style="stroke:#A80036;stroke-width:1.0;" width="705" x="1254" y="84"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="90" y="1280.1563"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="240.1094" style="stroke:#A80036;stroke-width:1.0;" width="10" x="257" y="501.7734"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="340.8125" style="stroke:#A80036;stroke-width:1.0;" width="10" x="257" y="2078.5391"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="278.1094" style="stroke:#A80036;stroke-width:1.0;" width="10" x="257" y="2596.1094"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="257" y="2991.2734"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="303.1641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="676" y="741.8828"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="148.4063" style="stroke:#A80036;stroke-width:1.0;" width="10" x="676" y="1162.1016"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="130.7578" style="stroke:#A80036;stroke-width:1.0;" width="10" x="676" y="1433.2109"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="147.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1116" y="2844.2188"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="147.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1318" y="390.0703"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="91.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1318" y="816.5859"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="183.4063" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1507" y="1015.0469"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="235.4609" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1507" y="1678.375"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="206.7578" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1896" y="2389.3516"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="95" x2="95" y1="167.6094" y2="3039.625"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="261.5" x2="261.5" y1="167.6094" y2="3039.625"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="681" x2="681" y1="167.6094" y2="3039.625"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1121" x2="1121" y1="167.6094" y2="3039.625"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1323" x2="1323" y1="167.6094" y2="3039.625"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1512" x2="1512" y1="167.6094" y2="3039.625"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1901" x2="1901" y1="167.6094" y2="3039.625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" text-decoration="underline" textLength="78" x="53" y="164.5332">Anwender:in</text><ellipse cx="95" cy="93" fill="#FEFECE" filter="url(#fb0tlklu3ox4y)" rx="8" ry="8" style="stroke:#A80036;stroke-width:2.0;"/><path d="M95,101 L95,128 M82,109 L108,109 M95,128 L82,143 M95,128 L108,143 " fill="none" filter="url(#fb0tlklu3ox4y)" style="stroke:#A80036;stroke-width:2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" text-decoration="underline" textLength="78" x="53" y="3053.1582">Anwender:in</text><ellipse cx="95" cy="3066.2344" fill="#FEFECE" filter="url(#fb0tlklu3ox4y)" rx="8" ry="8" style="stroke:#A80036;stroke-width:2.0;"/><path d="M95,3074.2344 L95,3101.2344 M82,3082.2344 L108,3082.2344 M95,3101.2344 L82,3116.2344 M95,3101.2344 L108,3116.2344 " fill="none" filter="url(#fb0tlklu3ox4y)" style="stroke:#A80036;stroke-width:2.0;"/><rect fill="#FEFECE" filter="url(#fb0tlklu3ox4y)" height="31.6094" rx="10" ry="10" style="stroke:#A80036;stroke-width:1.5;" width="75" x="222.5" y="131"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" text-decoration="underline" textLength="61" x="229.5" y="152.5332">Fachlogik</text><rect fill="#FEFECE" filter="url(#fb0tlklu3ox4y)" height="31.6094" rx="10" ry="10" style="stroke:#A80036;stroke-width:1.5;" width="75" x="222.5" y="3038.625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" text-decoration="underline" textLength="61" x="229.5" y="3060.1582">Fachlogik</text><rect fill="#FEFECE" filter="url(#fb0tlklu3ox4y)" height="31.6094" rx="10" ry="10" style="stroke:#A80036;stroke-width:1.5;" width="98" x="630" y="131"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" text-decoration="underline" textLength="84" x="637" y="152.5332">Authenticator</text><rect fill="#FEFECE" filter="url(#fb0tlklu3ox4y)" height="31.6094" rx="10" ry="10" style="stroke:#A80036;stroke-width:1.5;" width="98" x="630" y="3038.625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" text-decoration="underline" textLength="84" x="637" y="3060.1582">Authenticator</text><rect fill="#FEFECE" filter="url(#fb0tlklu3ox4y)" height="31.6094" rx="10" ry="10" style="stroke:#A80036;stroke-width:1.5;" width="84" x="1077" y="131"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" text-decoration="underline" textLength="70" x="1084" y="152.5332">Fachdienst</text><rect fill="#FEFECE" filter="url(#fb0tlklu3ox4y)" height="31.6094" rx="10" ry="10" style="stroke:#A80036;stroke-width:1.5;" width="84" x="1077" y="3038.625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" text-decoration="underline" textLength="70" x="1084" y="3060.1582">Fachdienst</text><rect fill="#FEFECE" filter="url(#fb0tlklu3ox4y)" height="31.6094" rx="10" ry="10" style="stroke:#A80036;stroke-width:1.5;" width="106" x="1268" y="131"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" text-decoration="underline" textLength="92" x="1275" y="152.5332">IDP_Discovery</text><rect fill="#FEFECE" filter="url(#fb0tlklu3ox4y)" height="31.6094" rx="10" ry="10" style="stroke:#A80036;stroke-width:1.5;" width="106" x="1268" y="3038.625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" text-decoration="underline" textLength="92" x="1275" y="3060.1582">IDP_Discovery</text><rect fill="#FEFECE" filter="url(#fb0tlklu3ox4y)" height="31.6094" rx="10" ry="10" style="stroke:#A80036;stroke-width:1.5;" width="126" x="1447" y="131"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" text-decoration="underline" textLength="112" x="1454" y="152.5332">IDP_Authorization</text><rect fill="#FEFECE" filter="url(#fb0tlklu3ox4y)" height="31.6094" rx="10" ry="10" style="stroke:#A80036;stroke-width:1.5;" width="126" x="1447" y="3038.625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" text-decoration="underline" textLength="112" x="1454" y="3060.1582">IDP_Authorization</text><rect fill="#FEFECE" filter="url(#fb0tlklu3ox4y)" height="31.6094" rx="10" ry="10" style="stroke:#A80036;stroke-width:1.5;" width="84" x="1857" y="131"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" text-decoration="underline" textLength="70" x="1864" y="152.5332">IDP_Token</text><rect fill="#FEFECE" filter="url(#fb0tlklu3ox4y)" height="31.6094" rx="10" ry="10" style="stroke:#A80036;stroke-width:1.5;" width="84" x="1857" y="3038.625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" text-decoration="underline" textLength="70" x="1864" y="3060.1582">IDP_Token</text><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="90" y="1280.1563"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="240.1094" style="stroke:#A80036;stroke-width:1.0;" width="10" x="257" y="501.7734"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="340.8125" style="stroke:#A80036;stroke-width:1.0;" width="10" x="257" y="2078.5391"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="278.1094" style="stroke:#A80036;stroke-width:1.0;" width="10" x="257" y="2596.1094"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="257" y="2991.2734"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="303.1641" style="stroke:#A80036;stroke-width:1.0;" width="10" x="676" y="741.8828"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="148.4063" style="stroke:#A80036;stroke-width:1.0;" width="10" x="676" y="1162.1016"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="130.7578" style="stroke:#A80036;stroke-width:1.0;" width="10" x="676" y="1433.2109"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="147.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1116" y="2844.2188"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="147.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1318" y="390.0703"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="91.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1318" y="816.5859"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="183.4063" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1507" y="1015.0469"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="235.4609" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1507" y="1678.375"/><rect fill="#FFFFFF" filter="url(#fb0tlklu3ox4y)" height="206.7578" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1896" y="2389.3516"/><path d="M49,192.6094 L49,247.6094 A10,10 0 0 0 59,257.6094 L1936,257.6094 A10,10 0 0 0 1946,247.6094 L1946,192.6094 L1936,182.6094 L59,182.6094 A10,10 0 0 0 49,192.6094 " fill="#FFFFA0" filter="url(#fb0tlklu3ox4y)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1936,182.6094 L1936,187.6094 A5,5 0 0 0 1941,192.6094 L1946,192.6094 L1936,182.6094 " fill="#FFFFA0" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="206" x="612" y="201.1045">In the following sequence diagramm</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="620" y="217.4561"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="63" x="620" y="217.4561">jwt(XXXX)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="162" x="687" y="217.4561">denotes a JSON web token,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="67" x="857" y="217.4561">jwe(XXXX)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="230" x="928" y="217.4561">denotes an encrypted JSON web token,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="57" x="1162" y="217.4561">jwk(XXX)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="147" x="1223" y="217.4561">denotes a JSON web key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="616" y="233.8076"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="218" x="612" y="250.1592">lightgreen hexagons contain PKI infos</text><rect fill="#EEEEEE" filter="url(#fb0tlklu3ox4y)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2212" x="0" y="328.1914"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2212" y1="328.1914" y2="328.1914"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2212" y1="331.1914" y2="331.1914"/><rect fill="#EEEEEE" filter="url(#fb0tlklu3ox4y)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="133" x="1039.5" y="317.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="111" x="1045.5" y="334.5107">get discovery doc</text><polygon fill="#A80036" points="1306,386.0703,1316,390.0703,1306,394.0703,1310,390.0703" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="262" x2="1312" y1="390.0703" y2="390.0703"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="11" x="269" y="377.0381">1)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="288" y="368.8623">getDiscoveryDocument()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="75" x="288" y="385.2139">GET uri_disc</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1328" x2="1370" y1="450.4219" y2="450.4219"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1370" x2="1370" y1="450.4219" y2="463.4219"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1329" x2="1370" y1="463.4219" y2="463.4219"/><polygon fill="#A80036" points="1339,459.4219,1329,463.4219,1339,467.4219,1335,463.4219" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="11" x="1335" y="445.5654">2)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146" x="1354" y="445.5654">build discovery document</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1328" x2="1375" y1="488.7734" y2="488.7734"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1375" x2="1375" y1="488.7734" y2="501.7734"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1334" x2="1375" y1="501.7734" y2="501.7734"/><polygon fill="#A80036" points="1344,497.7734,1334,501.7734,1344,505.7734,1340,501.7734" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="11" x="1340" y="483.917">3)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143" x="1359" y="483.917">sign discovery document</text><polygon fill="#90EE90" filter="url(#fb0tlklu3ox4y)" points="1519,480.9219,1644,480.9219,1654,492.9219,1644,504.9219,1519,504.9219,1509,492.9219,1519,480.9219" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="1521" y="498.417">sign with prk_idp_sig</text><polygon fill="#A80036" points="278,533.125,268,537.125,278,541.125,274,537.125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="272" x2="1322" y1="537.125" y2="537.125"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="11" x="284" y="532.2686">4)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="237" x="303" y="532.2686">RETURN jwt(signed discovery document)</text><line style="stroke:#A80036;stroke-width:1.0;" x1="267" x2="309" y1="567.4766" y2="567.4766"/><line style="stroke:#A80036;stroke-width:1.0;" x1="309" x2="309" y1="567.4766" y2="580.4766"/><line style="stroke:#A80036;stroke-width:1.0;" x1="268" x2="309" y1="580.4766" y2="580.4766"/><polygon fill="#A80036" points="278,576.4766,268,580.4766,278,584.4766,274,580.4766" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="11" x="274" y="562.6201">5)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="288" x="293" y="562.6201">validate signature (tuc_pki18 auf puk_idp_sig cert)</text><polygon fill="#90EE90" filter="url(#fb0tlklu3ox4y)" points="603,554.625,726,554.625,736,566.625,726,578.625,603,578.625,593,566.625,603,554.625" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="605" y="572.1201">cert from x5c header</text><rect fill="#EEEEEE" filter="url(#fb0tlklu3ox4y)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2212" x="0" y="609.6523"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2212" y1="609.6523" y2="609.6523"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2212" y1="612.6523" y2="612.6523"/><rect fill="#EEEEEE" filter="url(#fb0tlklu3ox4y)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="147" x="1032.5" y="598.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="129" x="1038.5" y="615.9717">choose code verifier</text><line style="stroke:#A80036;stroke-width:1.0;" x1="267" x2="309" y1="655.1797" y2="655.1797"/><line style="stroke:#A80036;stroke-width:1.0;" x1="309" x2="309" y1="655.1797" y2="668.1797"/><line style="stroke:#A80036;stroke-width:1.0;" x1="268" x2="309" y1="668.1797" y2="668.1797"/><polygon fill="#A80036" points="278,664.1797,268,668.1797,278,672.1797,274,668.1797" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="11" x="274" y="650.3232">6)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157" x="293" y="650.3232">generate CODE_VERIFIER</text><line style="stroke:#A80036;stroke-width:1.0;" x1="267" x2="309" y1="698.5313" y2="698.5313"/><line style="stroke:#A80036;stroke-width:1.0;" x1="309" x2="309" y1="698.5313" y2="711.5313"/><line style="stroke:#A80036;stroke-width:1.0;" x1="268" x2="309" y1="711.5313" y2="711.5313"/><polygon fill="#A80036" points="278,707.5313,268,711.5313,278,715.5313,274,711.5313" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="11" x="274" y="693.6748">7)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="277" x="293" y="693.6748">CODE_CHALLENGE = hash(CODE_VERIFIER)</text><polygon fill="#90EE90" filter="url(#fb0tlklu3ox4y)" points="592,685.6797,638,685.6797,648,697.6797,638,709.6797,592,709.6797,582,697.6797,592,685.6797" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="42" x="594" y="703.1748">sha256</text><polygon fill="#A80036" points="664,737.8828,674,741.8828,664,745.8828,668,741.8828" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="262" x2="670" y1="741.8828" y2="741.8828"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="11" x="269" y="737.0264">8)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="288" y="737.0264">forward CODE_CHALLENGE</text><rect fill="#EEEEEE" filter="url(#fb0tlklu3ox4y)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2212" x="0" y="771.0586"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2212" y1="771.0586" y2="771.0586"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2212" y1="774.0586" y2="774.0586"/><rect fill="#EEEEEE" filter="url(#fb0tlklu3ox4y)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="127" x="1042.5" y="759.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="109" x="1048.5" y="777.3779">get keys from Idp</text><polygon fill="#A80036" points="1306,812.5859,1316,816.5859,1306,820.5859,1310,816.5859" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="686" x2="1312" y1="816.5859" y2="816.5859"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="11" x="693" y="811.7295">9)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124" x="712" y="811.7295">GET uri_puk_idp_enc</text><polygon fill="#A80036" points="697,842.9375,687,846.9375,697,850.9375,693,846.9375" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="691" x2="1317" y1="846.9375" y2="846.9375"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="703" y="842.0811">10)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="219" x="729" y="842.0811">RETURN jwk(puk_idp_enc public key)</text><polygon fill="#A80036" points="1306,873.2891,1316,877.2891,1306,881.2891,1310,877.2891" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="686" x2="1312" y1="877.2891" y2="877.2891"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="693" y="872.4326">11)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="719" y="872.4326">GET uri_puk_idp_sig</text><polygon fill="#A80036" points="697,903.6406,687,907.6406,697,911.6406,693,907.6406" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="691" x2="1322" y1="907.6406" y2="907.6406"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="703" y="902.7842">12)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="212" x="729" y="902.7842">RETURN jwk(puk_idp_sig certificate)</text><rect fill="#EEEEEE" filter="url(#fb0tlklu3ox4y)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2212" x="0" y="936.8164"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2212" y1="936.8164" y2="936.8164"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2212" y1="939.8164" y2="939.8164"/><rect fill="#EEEEEE" filter="url(#fb0tlklu3ox4y)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="227" x="992.5" y="925.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="209" x="998.5" y="943.1357">request authentication challenge</text><polygon fill="#A80036" points="1495,1011.0469,1505,1015.0469,1495,1019.0469,1499,1015.0469" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="686" x2="1501" y1="1015.0469" y2="1015.0469"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="693" y="993.8389">13)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166" x="719" y="977.4873">getAuthenticationChallenge()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="719" y="993.8389">GET authorization_endpoint</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="311" x="719" y="1010.1904">client_id, state, redirecturl, code_challenge, scope, ...</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1517" x2="1559" y1="1075.3984" y2="1075.3984"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1559" x2="1559" y1="1075.3984" y2="1088.3984"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1518" x2="1559" y1="1088.3984" y2="1088.3984"/><polygon fill="#A80036" points="1528,1084.3984,1518,1088.3984,1528,1092.3984,1524,1088.3984" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="1524" y="1070.542">14)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="118" x="1550" y="1070.542">create CHALLENGE</text><path d="M1356,1069.5469 L1356,1075.5469 A10,10 0 0 0 1366,1085.5469 L1488,1085.5469 A10,10 0 0 0 1498,1075.5469 L1498,1069.5469 L1488,1059.5469 L1366,1059.5469 A10,10 0 0 0 1356,1069.5469 " fill="#90EE90" filter="url(#fb0tlklu3ox4y)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1488,1059.5469 L1488,1064.5469 A5,5 0 0 0 1493,1069.5469 L1498,1069.5469 L1488,1059.5469 " fill="#90EE90" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="1362" y="1078.042">sign with prk_idp_sig</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1517" x2="1559" y1="1118.75" y2="1118.75"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1559" x2="1559" y1="1118.75" y2="1131.75"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1518" x2="1559" y1="1131.75" y2="1131.75"/><polygon fill="#A80036" points="1528,1127.75,1518,1131.75,1528,1135.75,1524,1131.75" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="1524" y="1113.8936">15)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="166" x="1550" y="1113.8936">create USER_CONSENT list</text><polygon fill="#A80036" points="697,1158.1016,687,1162.1016,697,1166.1016,693,1162.1016" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="691" x2="1506" y1="1162.1016" y2="1162.1016"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="703" y="1157.2451">16)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="271" x="729" y="1157.2451">RETURN jwt(CHALLENGE, USER_CONSENT)</text><line style="stroke:#A80036;stroke-width:1.0;" x1="686" x2="728" y1="1197.4531" y2="1197.4531"/><line style="stroke:#A80036;stroke-width:1.0;" x1="728" x2="728" y1="1197.4531" y2="1210.4531"/><line style="stroke:#A80036;stroke-width:1.0;" x1="681" x2="728" y1="1210.4531" y2="1210.4531"/><polygon fill="#A80036" points="691,1206.4531,681,1210.4531,691,1214.4531,687,1210.4531" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="693" y="1192.5967">17)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="182" x="719" y="1192.5967">validate CHALLENGE signature</text><path d="M913,1186.6016 L913,1192.6016 A10,10 0 0 0 923,1202.6016 L1067,1202.6016 A10,10 0 0 0 1077,1192.6016 L1077,1186.6016 L1067,1176.6016 L923,1176.6016 A10,10 0 0 0 913,1186.6016 " fill="#90EE90" filter="url(#fb0tlklu3ox4y)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1067,1176.6016 L1067,1181.6016 A5,5 0 0 0 1072,1186.6016 L1077,1186.6016 L1067,1176.6016 " fill="#90EE90" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143" x="919" y="1195.0967">validate with puk_idp_sig</text><rect fill="#EEEEEE" filter="url(#fb0tlklu3ox4y)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2212" x="0" y="1234.6289"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2212" y1="1234.6289" y2="1234.6289"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2212" y1="1237.6289" y2="1237.6289"/><rect fill="#EEEEEE" filter="url(#fb0tlklu3ox4y)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="150" x="1031" y="1223.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="132" x="1037" y="1240.9482">confirm user consent</text><polygon fill="#A80036" points="111,1276.1563,101,1280.1563,111,1284.1563,107,1280.1563" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="105" x2="675" y1="1280.1563" y2="1280.1563"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="117" y="1275.2998">18)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="150" x="143" y="1275.2998">display USER_CONSENT</text><polygon fill="#A80036" points="669,1306.5078,679,1310.5078,669,1314.5078,673,1310.5078" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="95" x2="675" y1="1310.5078" y2="1310.5078"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="102" y="1305.6514">19)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="128" y="1305.6514">confirm USER_CONSENT</text><rect fill="#EEEEEE" filter="url(#fb0tlklu3ox4y)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2212" x="0" y="1379.6836"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2212" y1="1379.6836" y2="1379.6836"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2212" y1="1382.6836" y2="1382.6836"/><rect fill="#EEEEEE" filter="url(#fb0tlklu3ox4y)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="111" x="1050.5" y="1368.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="93" x="1056.5" y="1386.0029">sign challenge</text><line style="stroke:#A80036;stroke-width:1.0;" x1="681" x2="728" y1="1420.2109" y2="1420.2109"/><line style="stroke:#A80036;stroke-width:1.0;" x1="728" x2="728" y1="1420.2109" y2="1433.2109"/><line style="stroke:#A80036;stroke-width:1.0;" x1="687" x2="728" y1="1433.2109" y2="1433.2109"/><polygon fill="#A80036" points="697,1429.2109,687,1433.2109,697,1437.2109,693,1433.2109" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="693" y="1415.3545">20)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="376" x="719" y="1415.3545">read AUT certificate from SMC-B (via Konnector) or eGK per NFC</text><line style="stroke:#A80036;stroke-width:1.0;" x1="686" x2="728" y1="1498.2656" y2="1498.2656"/><line style="stroke:#A80036;stroke-width:1.0;" x1="728" x2="728" y1="1498.2656" y2="1511.2656"/><line style="stroke:#A80036;stroke-width:1.0;" x1="687" x2="728" y1="1511.2656" y2="1511.2656"/><polygon fill="#A80036" points="697,1507.2656,687,1511.2656,697,1515.2656,693,1511.2656" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="693" y="1485.2334">21)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="386" x="719" y="1477.0576">SIGNED_CHALLENGE = jws(njwt: CHALLENGE, aut certificate im</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="68" x="719" y="1493.4092">x5c header)</text><polygon fill="#90EE90" filter="url(#fb0tlklu3ox4y)" points="1131,1470.5625,1358,1470.5625,1368,1482.5625,1358,1494.5625,1131,1494.5625,1121,1482.5625,1131,1470.5625" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="1133" y="1488.0576">sign with c.ch.aut / c.hci.aut / c.hp.aut</text><path d="M363,1461.2109 L363,1500.2109 A10,10 0 0 0 373,1510.2109 L657,1510.2109 A10,10 0 0 0 667,1500.2109 L667,1461.2109 L657,1451.2109 L373,1451.2109 A10,10 0 0 0 363,1461.2109 " fill="#FBFB77" filter="url(#fb0tlklu3ox4y)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M657,1451.2109 L657,1456.2109 A5,5 0 0 0 662,1461.2109 L667,1461.2109 L657,1451.2109 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="225" x="369" y="1469.7061">since Primärsystem has no private key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="283" x="369" y="1486.0576">the signature has to be created on the Konnektor</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="221" x="369" y="1502.4092">via the externalized signature interface</text><line style="stroke:#A80036;stroke-width:1.0;" x1="686" x2="728" y1="1562.9688" y2="1562.9688"/><line style="stroke:#A80036;stroke-width:1.0;" x1="728" x2="728" y1="1562.9688" y2="1575.9688"/><line style="stroke:#A80036;stroke-width:1.0;" x1="681" x2="728" y1="1575.9688" y2="1575.9688"/><polygon fill="#A80036" points="691,1571.9688,681,1575.9688,691,1579.9688,687,1575.9688" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="693" y="1549.9365">22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="286" x="719" y="1541.7607">ENCRYPTED_SIGNED_CHALLENGE = jwe(njwt:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="719" y="1558.1123">SIGNED_CHALLENGE)</text><polygon fill="#90EE90" filter="url(#fb0tlklu3ox4y)" points="1031,1536.9414,1182,1536.9414,1192,1548.9414,1182,1560.9414,1031,1560.9414,1021,1548.9414,1031,1536.9414" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="147" x="1033" y="1554.4365">encrypt with puk_idp_enc</text><rect fill="#EEEEEE" filter="url(#fb0tlklu3ox4y)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2212" x="0" y="1600.1445"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2212" y1="1600.1445" y2="1600.1445"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2212" y1="1603.1445" y2="1603.1445"/><rect fill="#EEEEEE" filter="url(#fb0tlklu3ox4y)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="188" x="1012" y="1588.9688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="170" x="1018" y="1606.4639">request authorization code</text><polygon fill="#A80036" points="1495,1674.375,1505,1678.375,1495,1682.375,1499,1678.375" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="681" x2="1501" y1="1678.375" y2="1678.375"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="688" y="1657.167">23)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94" x="714" y="1640.8154">GetTokenCode()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="169" x="718" y="1657.167">POST authorization_endpoint</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="389" x="714" y="1673.5186">ENCRYPTED_SIGNED_CHALLENGE with certificate in x5c header</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1517" x2="1559" y1="1742.4023" y2="1742.4023"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1559" x2="1559" y1="1742.4023" y2="1755.4023"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1518" x2="1559" y1="1755.4023" y2="1755.4023"/><polygon fill="#A80036" points="1528,1751.4023,1518,1755.4023,1528,1759.4023,1524,1755.4023" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="1524" y="1737.5459">24)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="339" x="1550" y="1737.5459">decrypt and validate ENCRYPTED_SIGNED_CHALLENGE</text><polygon fill="#90EE90" filter="url(#fb0tlklu3ox4y)" points="1250,1721.375,1492,1721.375,1502,1741.375,1492,1761.375,1250,1761.375,1240,1741.375,1250,1721.375" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="238" x="1252" y="1738.8701">validate SIGNED_CHALLENGE signature</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="103" x="1252" y="1755.2217">validate certificate</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1517" x2="1559" y1="1789.4297" y2="1789.4297"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1559" x2="1559" y1="1789.4297" y2="1802.4297"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1518" x2="1559" y1="1802.4297" y2="1802.4297"/><polygon fill="#A80036" points="1528,1798.4297,1518,1802.4297,1528,1806.4297,1524,1802.4297" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="1524" y="1784.5732">25)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="199" x="1550" y="1784.5732">generate AUTHORIZATION_CODE</text><polygon fill="#90EE90" filter="url(#fb0tlklu3ox4y)" points="1367,1776.5781,1492,1776.5781,1502,1788.5781,1492,1800.5781,1367,1800.5781,1357,1788.5781,1367,1776.5781" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="1369" y="1794.0732">sign with prk_idp_sig</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1517" x2="1559" y1="1832.7813" y2="1832.7813"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1559" x2="1559" y1="1832.7813" y2="1845.7813"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1518" x2="1559" y1="1845.7813" y2="1845.7813"/><polygon fill="#A80036" points="1528,1841.7813,1518,1845.7813,1528,1849.7813,1524,1845.7813" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="1524" y="1827.9248">26)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="1550" y="1827.9248">generate SSO_TOKEN</text><polygon fill="#A80036" points="692,1909.8359,682,1913.8359,692,1917.8359,688,1913.8359" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="686" x2="1511" y1="1913.8359" y2="1913.8359"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="698" y="1892.6279">27)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="318" x="724" y="1876.2764">RETURN 302 redirect to Fachlogik with location header</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="270" x="724" y="1892.6279">containing AUTHORIZATION_CODE, state and</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="173" x="724" y="1908.9795">SSO_TOKEN as query param</text><path d="M360,1868.7813 L360,1907.7813 A10,10 0 0 0 370,1917.7813 L662,1917.7813 A10,10 0 0 0 672,1907.7813 L672,1868.7813 L662,1858.7813 L370,1858.7813 A10,10 0 0 0 360,1868.7813 " fill="#FBFB77" filter="url(#fb0tlklu3ox4y)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M662,1858.7813 L662,1863.7813 A5,5 0 0 0 667,1868.7813 L672,1868.7813 L662,1858.7813 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="281" x="366" y="1877.2764">sso token can be omitted (returned as null value)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="291" x="366" y="1893.6279">for specific client_ids configured on the IDP server.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="236" x="366" y="1909.9795">This specifically includes Primärsysteme</text><rect fill="#EEEEEE" filter="url(#fb0tlklu3ox4y)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2212" x="0" y="2033.0117"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2212" y1="2033.0117" y2="2033.0117"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2212" y1="2036.0117" y2="2036.0117"/><rect fill="#EEEEEE" filter="url(#fb0tlklu3ox4y)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="133" x="1039.5" y="2021.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="115" x="1045.5" y="2039.3311">create key verifier</text><polygon fill="#A80036" points="278,2074.5391,268,2078.5391,278,2082.5391,274,2078.5391" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="272" x2="680" y1="2078.5391" y2="2078.5391"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="284" y="2073.6826">28)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104" x="310" y="2073.6826">follow 302 redirect</text><line style="stroke:#A80036;stroke-width:1.0;" x1="267" x2="309" y1="2138.8906" y2="2138.8906"/><line style="stroke:#A80036;stroke-width:1.0;" x1="309" x2="309" y1="2138.8906" y2="2151.8906"/><line style="stroke:#A80036;stroke-width:1.0;" x1="268" x2="309" y1="2151.8906" y2="2151.8906"/><polygon fill="#A80036" points="278,2147.8906,268,2151.8906,278,2155.8906,274,2151.8906" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="274" y="2134.0342">29)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165" x="300" y="2134.0342">create random TOKEN_KEY</text><polygon fill="#90EE90" filter="url(#fb0tlklu3ox4y)" points="487,2126.0391,539,2126.0391,549,2138.0391,539,2150.0391,487,2150.0391,477,2138.0391,487,2126.0391" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="48" x="489" y="2143.5342">AES256</text><line style="stroke:#A80036;stroke-width:1.0;" x1="267" x2="309" y1="2182.2422" y2="2182.2422"/><line style="stroke:#A80036;stroke-width:1.0;" x1="309" x2="309" y1="2182.2422" y2="2195.2422"/><line style="stroke:#A80036;stroke-width:1.0;" x1="268" x2="309" y1="2195.2422" y2="2195.2422"/><polygon fill="#A80036" points="278,2191.2422,268,2195.2422,278,2199.2422,274,2195.2422" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="274" y="2177.3857">30)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="334" x="300" y="2177.3857">create KEY_VERIFIER (TOKEN_KEY, CODE_VERIFIER)</text><line style="stroke:#A80036;stroke-width:1.0;" x1="267" x2="309" y1="2225.5938" y2="2225.5938"/><line style="stroke:#A80036;stroke-width:1.0;" x1="309" x2="309" y1="2225.5938" y2="2238.5938"/><line style="stroke:#A80036;stroke-width:1.0;" x1="268" x2="309" y1="2238.5938" y2="2238.5938"/><polygon fill="#A80036" points="278,2234.5938,268,2238.5938,278,2242.5938,274,2238.5938" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="274" y="2220.7373">31)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="290" x="300" y="2220.7373">encrypted KEY_VERIFIER = jwe(KEY_VERIFIER)</text><polygon fill="#90EE90" filter="url(#fb0tlklu3ox4y)" points="612,2212.7422,763,2212.7422,773,2224.7422,763,2236.7422,612,2236.7422,602,2224.7422,612,2212.7422" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="147" x="614" y="2230.2373">encrypt with idp_puk_enc</text><line style="stroke:#A80036;stroke-width:1.0;" x1="267" x2="309" y1="2268.9453" y2="2268.9453"/><line style="stroke:#A80036;stroke-width:1.0;" x1="309" x2="309" y1="2268.9453" y2="2281.9453"/><line style="stroke:#A80036;stroke-width:1.0;" x1="268" x2="309" y1="2281.9453" y2="2281.9453"/><polygon fill="#A80036" points="278,2277.9453,268,2281.9453,278,2285.9453,274,2281.9453" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="274" y="2264.0889">32)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="369" x="300" y="2264.0889">store TOKEN_KEY (for derycpting access and id token later on)</text><rect fill="#EEEEEE" filter="url(#fb0tlklu3ox4y)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2212" x="0" y="2311.1211"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2212" y1="2311.1211" y2="2311.1211"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2212" y1="2314.1211" y2="2314.1211"/><rect fill="#EEEEEE" filter="url(#fb0tlklu3ox4y)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="83" x="1064.5" y="2299.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="65" x="1070.5" y="2317.4404">get tokens</text><polygon fill="#A80036" points="1884,2385.3516,1894,2389.3516,1884,2393.3516,1888,2389.3516" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="267" x2="1890" y1="2389.3516" y2="2389.3516"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="274" y="2368.1436">33)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="68" x="300" y="2351.792">getTokens()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="280" x="300" y="2368.1436">POST token_endpoint AUTHORIZATION_CODE,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="300" y="2384.4951">jwe(KEY_VERIFIER)</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1906" x2="1948" y1="2449.7031" y2="2449.7031"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1948" x2="1948" y1="2449.7031" y2="2462.7031"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1907" x2="1948" y1="2462.7031" y2="2462.7031"/><polygon fill="#A80036" points="1917,2458.7031,1907,2462.7031,1917,2466.7031,1913,2462.7031" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="1913" y="2444.8467">34)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="261" x="1939" y="2444.8467">decrypt KEY_VERIFIER jwe -&gt; TOKEN_KEY</text><polygon fill="#90EE90" filter="url(#fb0tlklu3ox4y)" points="1780,2436.8516,1881,2436.8516,1891,2448.8516,1881,2460.8516,1780,2460.8516,1770,2448.8516,1780,2436.8516" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="97" x="1782" y="2454.3467">with prk_idp_enc</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1906" x2="1948" y1="2493.0547" y2="2493.0547"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1948" x2="1948" y1="2493.0547" y2="2506.0547"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1907" x2="1948" y1="2506.0547" y2="2506.0547"/><polygon fill="#A80036" points="1917,2502.0547,1907,2506.0547,1917,2510.0547,1913,2506.0547" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="1913" y="2488.1982">35)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="236" x="1939" y="2488.1982">validate client, code and KEY_VERIFIER</text><polygon fill="#90EE90" filter="url(#fb0tlklu3ox4y)" points="1791,2480.2031,1881,2480.2031,1891,2492.2031,1881,2504.2031,1791,2504.2031,1781,2492.2031,1791,2480.2031" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="86" x="1793" y="2497.6982">verify signature</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1906" x2="1948" y1="2536.4063" y2="2536.4063"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1948" x2="1948" y1="2536.4063" y2="2549.4063"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1907" x2="1948" y1="2549.4063" y2="2549.4063"/><polygon fill="#A80036" points="1917,2545.4063,1907,2549.4063,1917,2553.4063,1913,2549.4063" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="1913" y="2531.5498">36)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="244" x="1939" y="2531.5498">encrypt ACCESS_TOKEN and ID_TOKEN</text><polygon fill="#90EE90" filter="url(#fb0tlklu3ox4y)" points="1772,2523.5547,1881,2523.5547,1891,2535.5547,1881,2547.5547,1772,2547.5547,1762,2535.5547,1772,2523.5547" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="105" x="1774" y="2541.0498">with TOKEN_KEY</text><polygon fill="#A80036" points="278,2592.1094,268,2596.1094,278,2600.1094,274,2596.1094" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="272" x2="1900" y1="2596.1094" y2="2596.1094"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="284" y="2583.0771">37)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="278" x="310" y="2574.9014">RETURN jwe(ACCESS_TOKEN, TOKEN_KEY),</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="310" y="2591.2529">jwe(ID_TOKEN, TOKEN_KEY)</text><rect fill="#EEEEEE" filter="url(#fb0tlklu3ox4y)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2212" x="0" y="2625.2852"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2212" y1="2625.2852" y2="2625.2852"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2212" y1="2628.2852" y2="2628.2852"/><rect fill="#EEEEEE" filter="url(#fb0tlklu3ox4y)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="214" x="999" y="2614.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="196" x="1005" y="2631.6045">use access token at Fachdienst</text><line style="stroke:#A80036;stroke-width:1.0;" x1="267" x2="309" y1="2670.8125" y2="2670.8125"/><line style="stroke:#A80036;stroke-width:1.0;" x1="309" x2="309" y1="2670.8125" y2="2683.8125"/><line style="stroke:#A80036;stroke-width:1.0;" x1="268" x2="309" y1="2683.8125" y2="2683.8125"/><polygon fill="#A80036" points="278,2679.8125,268,2683.8125,278,2687.8125,274,2683.8125" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="274" y="2665.9561">38)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="300" y="2665.9561">decrypt ACCESS_TOKEN</text><polygon fill="#90EE90" filter="url(#fb0tlklu3ox4y)" points="133,2657.9609,242,2657.9609,252,2669.9609,242,2681.9609,133,2681.9609,123,2669.9609,133,2657.9609" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="105" x="135" y="2675.4561">with TOKEN_KEY</text><line style="stroke:#A80036;stroke-width:1.0;" x1="267" x2="309" y1="2714.1641" y2="2714.1641"/><line style="stroke:#A80036;stroke-width:1.0;" x1="309" x2="309" y1="2714.1641" y2="2727.1641"/><line style="stroke:#A80036;stroke-width:1.0;" x1="268" x2="309" y1="2727.1641" y2="2727.1641"/><polygon fill="#A80036" points="278,2723.1641,268,2727.1641,278,2731.1641,274,2727.1641" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="274" y="2709.3076">39)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="110" x="300" y="2709.3076">decrypt ID_TOKEN</text><polygon fill="#90EE90" filter="url(#fb0tlklu3ox4y)" points="133,2701.3125,242,2701.3125,252,2713.3125,242,2725.3125,133,2725.3125,123,2713.3125,133,2701.3125" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="105" x="135" y="2718.8076">with TOKEN_KEY</text><line style="stroke:#A80036;stroke-width:1.0;" x1="267" x2="309" y1="2757.5156" y2="2757.5156"/><line style="stroke:#A80036;stroke-width:1.0;" x1="309" x2="309" y1="2757.5156" y2="2770.5156"/><line style="stroke:#A80036;stroke-width:1.0;" x1="268" x2="309" y1="2770.5156" y2="2770.5156"/><polygon fill="#A80036" points="278,2766.5156,268,2770.5156,278,2774.5156,274,2770.5156" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="274" y="2752.6592">40)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="244" x="300" y="2752.6592">validate ACCESS_TOKEN and ID_TOKEN</text><line style="stroke:#A80036;stroke-width:1.0;" x1="267" x2="309" y1="2800.8672" y2="2800.8672"/><line style="stroke:#A80036;stroke-width:1.0;" x1="309" x2="309" y1="2800.8672" y2="2813.8672"/><line style="stroke:#A80036;stroke-width:1.0;" x1="268" x2="309" y1="2813.8672" y2="2813.8672"/><polygon fill="#A80036" points="278,2809.8672,268,2813.8672,278,2817.8672,274,2813.8672" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="274" y="2796.0107">41)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="300" y="2796.0107">encrypt ACCESS_TOKEN</text><polygon fill="#90EE90" filter="url(#fb0tlklu3ox4y)" points="15,2788.0156,242,2788.0156,252,2800.0156,242,2812.0156,15,2812.0156,5,2800.0156,15,2788.0156" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="17" y="2805.5107">with shared secret between FL and FD</text><polygon fill="#A80036" points="1104,2840.2188,1114,2844.2188,1104,2848.2188,1108,2844.2188" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="267" x2="1110" y1="2844.2188" y2="2844.2188"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="274" y="2839.3623">42)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="261" x="300" y="2839.3623">sendAccessTokenAndRequestedFachdaten()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1126" x2="1168" y1="2904.5703" y2="2904.5703"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1168" x2="1168" y1="2904.5703" y2="2917.5703"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1127" x2="1168" y1="2917.5703" y2="2917.5703"/><polygon fill="#A80036" points="1137,2913.5703,1127,2917.5703,1137,2921.5703,1133,2917.5703" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="1133" y="2899.7139">43)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="1159" y="2899.7139">validate ACCESS_TOKEN</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1126" x2="1168" y1="2947.9219" y2="2947.9219"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1168" x2="1168" y1="2947.9219" y2="2960.9219"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1127" x2="1168" y1="2960.9219" y2="2960.9219"/><polygon fill="#A80036" points="1137,2956.9219,1127,2960.9219,1137,2964.9219,1133,2960.9219" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="1133" y="2943.0654">44)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="1159" y="2943.0654">getClaims()</text><polygon fill="#A80036" points="278,2987.2734,268,2991.2734,278,2995.2734,274,2991.2734" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="272" x2="1120" y1="2991.2734" y2="2991.2734"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="284" y="2986.417">45)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="310" y="2986.417">RETURN Fachdaten</text><polygon fill="#A80036" points="106,3017.625,96,3021.625,106,3025.625,102,3021.625" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="100" x2="261" y1="3021.625" y2="3021.625"/><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="18" x="112" y="3016.7686">46)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="112" x="138" y="3016.7686">displayFachDaten()</text><!--MD5=[ad2cc5e39b6bd6eedb527ba90cddc17f]
@startuml

title
<img:images/IDPLogo-64.png> <u>IDP workflow</u>
end title

skinparam sequenceArrowThickness 1
skinparam roundcorner 20
skinparam sequenceParticipant underline
skinparam maxMessageSize 400
skinparam ParticipantPadding 10

autonumber "<font color='blue'>##) "

!includesub workflow.base.puml!Actors

note across #ffffa0
  In the following sequence diagramm
    <b>jwt(XXXX)</b> denotes a JSON web token,  <b>jwe(XXXX)</b> denotes an encrypted JSON web token, <b>jwk(XXX)</b> denotes a JSON web key

  lightgreen hexagons contain PKI infos
end note

||40||

'!includesub workflow.base.puml!GetCertsFromFD
!includesub workflow.base.puml!GetDiscoveryDoc
!includesub workflow.base.puml!ChooseCodeVerifier
!includesub workflow.base.puml!GetKeysFromIDP
!includesub workflow.base.puml!RequestAuthenticationChallenge
!includesub workflow.base.puml!ConfirmUserConsent

||40||

'Für Primärsystemhersteller only
!includesub workflow.base.puml!SignChallenge
!includesub workflow.base.puml!RequestAuthorizationCodeWithSignedChallenge
||40||

'Für alle anderen
'alt #ffffe0 : <font color="#ff6000">request token code with SIGNED_CHALLENGE flow
'    !includesub workflow.base.puml!SignChallenge
'    !includesub workflow.base.puml!RequestAuthorizationCodeWithSignedChallenge
'    ||40||
'else #eeeeee : <font color="#333333">request token code with SSO Token flow
'    !includesub workflow.base.puml!RequestAuthorizationCodeWithSSOToken
'    ||40||
'else #ffeeee : <font color="red">request token code with ALT AUTH flow
'    !includesub workflow.base.puml!RequestAuthorizationCodeWithAltAuth
'    ||40||
'end
'authM -> authM : optionally store SSO_TOKEN

!includesub workflow.base.puml!CreateKeyVerifier

!includesub workflow.base.puml!GetTokens

!includesub workflow.base.puml!UseAccessTokenAtFD

@enduml

@startuml

title
<img:images/IDPLogo-64.png> <u>IDP workflow</u>
end title

skinparam sequenceArrowThickness 1
skinparam roundcorner 20
skinparam sequenceParticipant underline
skinparam maxMessageSize 400
skinparam ParticipantPadding 10

autonumber "<font color='blue'>##) "

actor "Anwender:in" as V
participant "Fachlogik" as FL
participant Authenticator as authM
participant Fachdienst as FD

box #skyblue
participant IDP_Discovery as IDPDisc
participant IDP_Authorization as IDPAuth
participant IDP_Token as IDPToken
endbox

note across #ffffa0
  In the following sequence diagramm
    <b>jwt(XXXX)</b> denotes a JSON web token,  <b>jwe(XXXX)</b> denotes an encrypted JSON web token, <b>jwk(XXX)</b> denotes a JSON web key

  lightgreen hexagons contain PKI infos
end note

||40||

== get discovery doc  ==
    FL -> IDPDisc ++ : getDiscoveryDocument()\nGET uri_disc
    deactivate FL
    IDPDisc -> IDPDisc : build discovery document
    IDPDisc -> IDPDisc : sign discovery document
    hnote right #lightgreen : sign with prk_idp_sig
    activate FL
    FL <- - IDPDisc - - : RETURN jwt(signed discovery document)
    FL -> FL : validate signature (tuc_pki18 auf puk_idp_sig cert)
    hnote right #lightgreen : cert from x5c header
== choose code verifier ==
    FL -> FL : generate CODE_VERIFIER
    FL -> FL : CODE_CHALLENGE = hash(CODE_VERIFIER)
    hnote right #lightgreen : sha256
    authM <- FL - - : forward CODE_CHALLENGE
== get keys from Idp ==
    activate authM
    authM -> IDPDisc ++ : GET uri_puk_idp_enc
    authM <- - IDPDisc : RETURN jwk(puk_idp_enc public key)
    authM -> IDPDisc : GET uri_puk_idp_sig
    authM <- - IDPDisc - - : RETURN jwk(puk_idp_sig certificate)
== request authentication challenge ==
    authM -> IDPAuth ++ : getAuthenticationChallenge()\nGET authorization_endpoint\nclient_id, state, redirecturl, code_challenge, scope, ...
    deactivate authM
    IDPAuth -> IDPAuth : create CHALLENGE
    note left #lightgreen : sign with prk_idp_sig
    IDPAuth -> IDPAuth : create USER_CONSENT list
    IDPAuth - -> authM ++ : RETURN jwt(CHALLENGE, USER_CONSENT)
    authM -> authM : validate CHALLENGE signature
    note right #lightgreen : validate with puk_idp_sig
    deactivate IDPAuth
== confirm user consent ==
    authM -> V ++ : display USER_CONSENT
    authM <- V - - : confirm USER_CONSENT
    deactivate authM

||40||

== sign challenge ==
    authM -> authM++ : read AUT certificate from SMC-B (via Konnector) or eGK per NFC
    authM -> authM : SIGNED_CHALLENGE = jws(njwt: CHALLENGE, aut certificate im x5c header)
    hnote right #lightgreen : sign with c.ch.aut / c.hci.aut / c.hp.aut
    note left
        since Primärsystem has no private key
        the signature has to be created on the Konnektor
        via the externalized signature interface
    end note
    authM -> authM- - : ENCRYPTED_SIGNED_CHALLENGE = jwe(njwt: SIGNED_CHALLENGE)
    hnote right #lightgreen : encrypt with puk_idp_enc
== request authorization code ==
    authM -> IDPAuth ++ : GetTokenCode()\n POST authorization_endpoint\nENCRYPTED_SIGNED_CHALLENGE with certificate in x5c header
    deactivate authM
    IDPAuth -> IDPAuth : decrypt and validate ENCRYPTED_SIGNED_CHALLENGE
    hnote left #lightgreen : validate SIGNED_CHALLENGE signature\nvalidate certificate
    IDPAuth -> IDPAuth : generate AUTHORIZATION_CODE
    hnote left #lightgreen : sign with prk_idp_sig
    IDPAuth -> IDPAuth : generate SSO_TOKEN
    IDPAuth - -> authM : RETURN 302 redirect to Fachlogik with location header\ncontaining AUTHORIZATION_CODE, state and\nSSO_TOKEN as query param
    note left : sso token can be omitted (returned as null value)\nfor specific client_ids configured on the IDP server.\nThis specifically includes Primärsysteme
    deactivate authM
    deactivate IDPAuth
    ||45||
||40||


== create key verifier ==
    authM -> FL ++ : follow 302 redirect
    deactivate authM
    FL -> FL : create random TOKEN_KEY
    hnote right #lightgreen : AES256
    FL -> FL : create KEY_VERIFIER (TOKEN_KEY, CODE_VERIFIER)
    FL -> FL : encrypted KEY_VERIFIER = jwe(KEY_VERIFIER)
    hnote right #lightgreen : encrypt with idp_puk_enc
    FL -> FL : store TOKEN_KEY (for derycpting access and id token later on)

== get tokens ==
    FL -> IDPToken ++ : getTokens()\nPOST token_endpoint AUTHORIZATION_CODE, jwe(KEY_VERIFIER)
    deactivate FL
    IDPToken -> IDPToken : decrypt KEY_VERIFIER jwe -> TOKEN_KEY
    hnote left #lightgreen : with prk_idp_enc
    IDPToken -> IDPToken : validate client, code and KEY_VERIFIER
    hnote left #lightgreen : verify signature
    IDPToken -> IDPToken : encrypt ACCESS_TOKEN and ID_TOKEN
    hnote left #lightgreen : with TOKEN_KEY
    FL <- - IDPToken - - : RETURN jwe(ACCESS_TOKEN, TOKEN_KEY),\njwe(ID_TOKEN, TOKEN_KEY)

== use access token at Fachdienst ==

    activate FL
    FL -> FL : decrypt ACCESS_TOKEN
    hnote left #lightgreen : with TOKEN_KEY
    FL -> FL : decrypt ID_TOKEN
    hnote left #lightgreen : with TOKEN_KEY
    FL -> FL : validate ACCESS_TOKEN and ID_TOKEN
    FL -> FL : encrypt ACCESS_TOKEN
    hnote left #lightgreen : with shared secret between FL and FD
    FL -> FD ++ : sendAccessTokenAndRequestedFachdaten()
    deactivate FL
    FD -> FD : validate ACCESS_TOKEN
    FD -> FD : getClaims()
    FL <- - FD - - : RETURN Fachdaten
    activate FL
    FL -> V : displayFachDaten()
    deactivate FL

@enduml

PlantUML version 1.2021.5(Sun Apr 25 13:20:28 CEST 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: Dynamic Code Evolution 64-Bit Server VM
Default Encoding: Cp1252
Language: en
Country: US
--></g></svg>